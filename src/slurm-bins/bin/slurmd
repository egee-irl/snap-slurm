#!/bin/bash

set -e

. "$SNAP/utilities/common-utilities"

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$SNAP/lib/x86_64-linux-gnu/:$SNAP/lib/:$SNAP/usr/local/lib:$SNAP/usr/lib/x86_64-linux-gnu/:$SNAP/lib/slurm



SLURM_CONF=$SNAP_COMMON/etc/slurm/slurm.conf
SLURMD_LOG=$SNAP_COMMON/log/slurmd.log
SLURMCTLD_INIT=$SNAP_COMMON/slurmctld-init-complete

# Check to see if we should even start
snap_mode=$(cat $SNAP_COMMON/snap_mode)
if ! [[ $snap_mode == "slurmd" || $snap_mode = "all" ]]; then
        exit 0
fi

slurmctld_init()
{
        # Arguments:
        #  -f: Force the check, i.e. ignore if it's currently in setup
        [ -f "$SLURMCTLD_INIT" ]
}

wait_for_slurmctld_init()
{
        wait_for_command "Waiting for SLURMCTLD to initialize" slurmctld_init "$@"
}

if [[ $snap_mode = "all" ]]; then
    wait_for_slurmctld_init
    sleep 10
fi

# Start slurmd only if we have a config file
if ! [[ -f $SLURM_CONF ]]; then
    pprint "No slurm conf, cannot start process.";
    exit 1
fi

pprint "Starting SLURMD";
exec "$SNAP/sbin/slurmd" \
    "-f" "$SLURM_CONF" \
    "-d" "$SNAP/sbin/slurmstepd" \
    "-L" "$SLURMD_LOG" \
    "-cDvvvvv" "$@"
